<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Travel Insurance Premium Calculation</title>

    <!-- Bootstrap CSS -->
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body>

<header th:replace="fragments/header :: header"></header>

<h2>Travel Insurance Premium Calculation</h2>

<form action="#" th:action="@{/insurance/travel/web/v2}" th:object="${request}" method="post"
      class="container mt-4">
    <div class="mb-3">
        <label for="agreementDateFrom" class="form-label">Agreement Date From:</label>
        <input type="date" id="agreementDateFrom" th:field="*{agreementDateFrom}"
               class="form-control"/>
    </div>

    <div class="mb-3">
        <label for="agreementDateTo" class="form-label">Agreement Date To:</label>
        <input type="date" id="agreementDateTo" th:field="*{agreementDateTo}" class="form-control"/>
    </div>

    <div class="mb-3">
        <label for="country" class="form-label">Country:</label>
        <input type="text" id="country" th:field="*{country}" class="form-control"/>
    </div>

    <div class="mb-3">
        <label for="selectedRisks" class="form-label">Selected Risks:</label>
        <textarea id="selectedRisks" th:field="*{selectedRisks}" class="form-control"></textarea>
    </div>

    <div id="persons-container">
        <!-- PersonRequestDTO dynamic forms will be added here -->
        <div th:each="person, personStat : *{persons}" class="card shadow-sm mt-3">
            <div class="card-body">
                <h3>Person <span th:text="${personStat.index + 1}"></span></h3>
                <div>
                    <label for="personFirstName" class="form-label">First Name:</label>
                    <input type="text"
                           th:field="*{persons[__${personStat.index}__].personFirstName}"
                           class="form-control"/>
                </div>

                <div>
                    <label for="personLastName" class="form-label">Last Name:</label>
                    <input type="text"
                           th:field="*{persons[__${personStat.index}__].personLastName}"
                           class="form-control"/>
                </div>

                <div>
                    <label for="personalCode" class="form-label">Personal Code:</label>
                    <input type="text" th:field="*{persons[__${personStat.index}__].personalCode}"
                           class="form-control"/>
                </div>

                <div>
                    <label for="personBirthDate" class="form-label">Birth Date:</label>
                    <input type="date"
                           th:field="*{persons[__${personStat.index}__].personBirthDate}"
                           class="form-control"/>
                </div>

                <div>
                    <label for="medicalRiskLimitLevel" class="form-label">Medical Risk Limit
                        Level:</label>
                    <input type="text"
                           th:field="*{persons[__${personStat.index}__].medicalRiskLimitLevel}"
                           class="form-control"/>
                </div>

                <div>
                    <label for="travelCost" class="form-label">Travel Cost:</label>
                    <input type="text" th:field="*{persons[__${personStat.index}__].travelCost}"
                           class="form-control"/>
                </div>

            </div>
        </div>
    </div>

    <button type="button" onclick="addPerson()" class="btn btn-primary">Add Person</button>
    <button type="button" onclick="removePerson()" class="btn btn-danger">Remove Person</button>
    <button type="submit" class="btn btn-success">Calculate Premium</button>
    <button type="button" onclick="clearForm()" class="btn btn-secondary">Clear</button>
</form>

<!-- Added condition if response != null -->
<div th:if="${response != null}">
    <td th:if="${response.persons != null}">
        <h3>Travel Insurance Premium Calculation PERSONS</h3>
        <div class="person-data" th:each="person : ${response.persons}">
            <h3 th:text="${person.personFirstName} + ' ' + ${person.personLastName}"></h3>
            <p th:text="'Personal Code: ' + ${person.personalCode}"></p>
            <p th:text="'Birth Date: ' + ${#dates.format(person.personBirthDate, 'yyyy-MM-dd')}"></p>
            <p th:if="${person.medicalRiskLimitLevel != null and !#strings.isEmpty(person.medicalRiskLimitLevel)}"
               th:text="'Medical Risk Limit Level: ' + ${person.medicalRiskLimitLevel}"></p>
            <p th:if="${person.travelCost} != null"
               th:text="'Travel Cost: ' + ${person.travelCost}"></p>
            <p th:text="'Person Premium: ' + ${person.personPremium}"></p>
            <p>Risks:</p>
            <ul>
                <li th:each="risk : ${person.personRisks}"
                    th:text="${risk.riskIc} + ': ' + ${risk.premium}"></li>
            </ul>
        </div>
    </td>

    <td th:if="${response.errors != null}">
        <h3>Travel Insurance Premium Calculation ERRORS</h3>
        <tr th:each="error : ${response.errors}">
    <td th:text="${error.errorCode}"/>
    <td th:text="${error.description}"/>


    </tr>
    </td>

    <h3>
        <label th:if="${response.agreementPremium != null}"
               th:text="'AGREEMENT PREMIUM: ' + ${response.agreementPremium}"></label>
    </h3>

</div>
<script>
    function addPerson() {
        let personsContainer = document.getElementById("persons-container");
        let index = document.getElementsByClassName("person-form").length;
        let personTemplate = `
            <div class="card shadow-sm mt-3">
                <div class="card-body">
                    <h3 class="text-primary">Person ${index + 1}</h3>

                    <div class="mb-3">
                        <label class="form-label" for="persons[${index}].personFirstName">First Name:</label>
                        <input type="text" class="form-control" id="persons[${index}].personFirstName" name="persons[${index}].personFirstName" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label" for="persons[${index}].personLastName">Last Name:</label>
                        <input type="text" class="form-control" id="persons[${index}].personLastName" name="persons[${index}].personLastName" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label" for="persons[${index}].personalCode">Personal Code:</label>
                        <input type="text" class="form-control" id="persons[${index}].personalCode" name="persons[${index}].personalCode" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label" for="persons[${index}].personBirthDate">Birth Date:</label>
                        <input type="date" class="form-control" id="persons[${index}].personBirthDate" name="persons[${index}].personBirthDate" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label" for="persons[${index}].medicalRiskLimitLevel">Medical Risk Limit Level:</label>
                        <input type="text" class="form-control" id="persons[${index}].medicalRiskLimitLevel" name="persons[${index}].medicalRiskLimitLevel" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label" for="persons[${index}].travelCost">Travel Cost:</label>
                        <input type="text" class="form-control" id="persons[${index}].travelCost" name="persons[${index}].travelCost" />
                    </div>
                </div>
            </div>`;
        personsContainer.insertAdjacentHTML('beforeend', personTemplate);
    }

    function removePerson() {
        let personsContainer = document.getElementById("persons-container");
        let personForms = document.getElementsByClassName("person-form");
        if (personForms.length > 0) {
            personsContainer.removeChild(personForms[personForms.length - 1]);
        }
    }

    document.addEventListener('DOMContentLoaded', (event) => {
        const agreementDateFrom = document.getElementById('agreementDateFrom');
        const agreementDateTo= document.getElementById('agreementDateTo');

        const today = new Date();

        const dateFrom = new Date();
        dateFrom.setDate(today.getDate() + 1);

        const dateTo = new Date();
        dateTo.setDate(today.getDate() + 2);

        agreementDateFrom.value = dateFrom.toISOString().split('T')[0];
        agreementDateTo.value = dateTo.toISOString().split('T')[0];
    });

    function clearForm() {
        window.location.href = window.location.href.split('?')[0];
    }

</script>

<!-- Bootstrap JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>